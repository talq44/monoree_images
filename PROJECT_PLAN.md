# [개발 명세서] 로컬 AI 이미지 일괄 생성기 (Mac Silicon 기반)

## 1. 프로젝트 개요

### 1.1. 목표

* **완전 무료 & 로컬 구동:** 외부 API 비용이나 네트워크 의존 없이, Apple Silicon(M1/M2/M3)이 탑재된 Mac의 GPU 자원을 활용하여 이미지를 생성한다.
* **배치(Batch) 자동화:** 텍스트 파일에 정의된 대량의 목록(키워드)을 읽어, 사용자가 지정한 프롬프트 템플릿에 맞춰 이미지를 연속 생성한다.
* **안정적 운용:** 장시간 구동 시 발열 관리 및 중단 시점부터 다시 시작하는 '이어하기' 기능을 포함한다.

### 1.2. 시스템 아키텍처

* **User Interface (Shell Script):** 사용자로부터 설정값(파일 경로, 저장 폴더, 프롬프트 등)을 입력받고 검증하는 역할.
* **Core Engine (Python):** 무거운 AI 모델을 메모리에 **단 한 번만 로드**하고, 전달받은 설정에 따라 고속으로 이미지를 연속 생성하는 역할.

---

## 2. 사용자 워크플로우 (Shell Script)

스크립트(`run.sh`) 실행 시 다음과 같은 단계로 입력을 받는다.

### 1단계: 대상 목록 파일 입력

* **Input:** 소스 텍스트 파일 경로 (예: `dataset/animals.txt`)
* **Validation:**
* 파일 존재 여부 확인 (`-f` 체크).
* 파일이 비어있는지 확인.
* 실패 시 에러 메시지 출력 후 재입력 요구.



### 2단계: 프로젝트 이름 (출력 경로)

* **Input:** 결과물을 저장할 폴더명 (예: `results/toy_project_01`)
* **Action:**
* 입력받은 경로에 폴더가 없으면 `mkdir -p`로 자동 생성.
* 폴더 생성 권한 확인.



### 3단계: 이미지 포맷 선택

* **Input:** 번호 선택 (1. PNG, 2. JPEG)
* **Logic:** 추후 Python 스크립트에 인자로 전달 (`--format png` 등).

### 3.1단계: 이미지 크기 선택

* **Input:** 번호 선택 (1. 256x256, 2. 512x512, 3. 1024x1024)
* **Logic:** 선택된 크기는 Python 스크립트에 `--width`와 `--height` 인자로 전달됩니다. 작은 크기는 생성 속도를 향상시키지만 품질이 저하될 수 있습니다.

### 4단계: 프롬프트 템플릿 설계

* **Input:** 프롬프트 문장 입력 (예: `A cute {{name}} made of felt, wool texture, 8k resolution`)
* **Validation:**
* 필수 치환자 `{{name}}` (또는 `{id}`) 포함 여부 검사.
* 누락 시 경고 메시지 출력 및 재입력.



### 5단계: 모델 선택 (고급 옵션 - 선택 사항)

* **Input:** 사용할 모델 스타일 선택 (1. 실사/Realistic, 2. 일러스트/2.5D, 3. 기본/SD1.5)
* **Action:** 선택지에 따라 사전에 정의된 Hugging Face 모델 ID를 매핑.

---

## 3. 핵심 실행 로직 (Python Engine)

기존 쉘 스크립트 반복 방식의 비효율(매 이미지마다 모델 로딩 시간 소요)을 제거하기 위해, Python 엔진이 루프를 담당한다.

### 3.1. 초기화 (Initialization)

1. **모델 로딩:** `Diffusers` 라이브러리를 통해 Stable Diffusion 모델을 메모리에 적재.
* **가속화:** `device="mps"` (Metal Performance Shaders) 사용하여 Mac GPU 활성화.
* **최적화:** `torch.float16` 사용하여 메모리 사용량 절반으로 감소.


2. **설정 수신:** 쉘 스크립트로부터 전달받은 인자(파일 경로, 프롬프트, 저장 폴더, 이미지 크기 등) 파싱.

### 3.2. 생성 루프 (Generation Loop)

1. **목록 읽기:** 입력된 텍스트 파일을 라인 단위로 읽어 리스트화.
2. **이어하기(Resume) 체크:**
* 생성할 파일명(예: `lion.png`)이 이미 출력 폴더에 존재하는지 확인.
* 존재할 경우: "⚠️ 건너뜀: lion.png 이미 존재함" 로그 출력 후 **생성 스킵**.
* 존재하지 않을 경우: 생성 프로세스 진입.


3. **프롬프트 조합:** 템플릿의 `{{name}}` 부분을 현재 라인의 텍스트로 치환.
4. **추론(Inference):**
* 모델을 통해 이미지 생성 (기본 30~50 step, 사용자가 선택한 `width`와 `height` 적용).
* **파일명 정제:** 파일명에 쓸 수 없는 특수문자(`/`, `:`, `\`)를 `_`로 치환.


5. **저장:** 지정된 포맷으로 이미지 파일 저장.

### 3.3. 하드웨어 보호 로직

* **쿨링 다운(Throttling Control):** 로컬 GPU 부하를 줄이기 위해 이미지 1장 생성 후 **최소 3~5초간 `time.sleep()**` 수행. (사용자가 시간 설정 가능하도록 옵션화)

---

## 4. 안정성 및 예외 처리

### 4.1. 오류 감지 및 복구

* **NSFW 필터:** 생성된 이미지가 검은색으로 나오거나 차단될 경우, 해당 이슈를 로그에 남기고 다음 순서로 넘어감 (중단 방지).
* **메모리 부족(OOM):** `mps` 메모리 부족 발생 시, 가비지 컬렉션(`torch.cuda.empty_cache()`의 mps 대응) 수행 시도.

### 4.2. 로그 시스템

* **콘솔 출력 (터미널):** `tqdm` 라이브러리를 사용하여 시각적인 진행률(Progress Bar) 표시.
> `[35/100] 35% |███-------| 생성 중: 'Tiger' (남은 시간: 5분 20초)`


* **파일 로그:** `session.log` 파일에 성공/실패/스킵 내역을 타임스탬프와 함께 기록.

---

## 5. 기술 스택 및 요구사항 (Mac 전용)

### 5.1. 하드웨어

* **Device:** Apple Silicon (M1, M2, M3 계열) 권장. (Intel Mac은 속도가 현저히 느림)
* **RAM:** 최소 8GB (16GB 이상 권장).

### 5.2. 소프트웨어

* **OS:** macOS Sonoma (14.0) 이상 권장.
* **Language:**
* Python 3.10 이상 (가상환경 `venv` 사용 필수).
* Bash Shell (`/bin/bash` or `/bin/zsh`).


* **Dependencies (Python):**
* `torch`, `torchvision` (Nightly build or Stable with MPS support)
* `diffusers` (Hugging Face)
* `transformers`, `accelerate`

---

## 6. 개발 로드맵

1. **환경셋업 (Phase 1):** Python 가상환경 구성 및 `mps` 가속 동작 테스트.
2. **엔진 구현 (Phase 2):** `generator.py` 작성 (모델 로드, 이미지 생성, 저장 기능).
3. **UI 구현 (Phase 3):** `run.sh` 작성 (사용자 입력, Python 스크립트 호출, 유효성 검사).
4. **최적화 (Phase 4):** 이어하기 기능 검증, 파일명 특수문자 처리, 발열 관리 딜레이 튜닝.

---

### 💡 이전 문서(API 방식)와의 주요 차이점 요약

| 구분 | 이전 (API 방식) | **현재 (로컬 방식)** |
| --- | --- | --- |
| **비용** | API 호출 건당 비용 발생 가능 | **완전 무료 (전기세 제외)** |
| **속도** | 네트워크 속도에 의존 | **내 GPU 성능에 의존** |
| **제어권** | API가 허용하는 옵션만 사용 가능 | **모델 교체, 스텝 수 등 무제한 튜닝** |
| **구조** | 쉘이 반복 호출해도 무방 | **Python이 반복 처리해야 효율적** (모델 로딩 시간 때문) |
| **제한** | 일일 호출량 제한 있음 | **발열 관리(Throttling)만 신경 쓰면 됨** |